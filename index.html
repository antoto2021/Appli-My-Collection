<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyCollection - Gestionnaire de Biblioth√®que</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel pour compiler le JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- HTML5-QRCode Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* Animation utilitaires */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100 selection:text-indigo-700">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        /**
         * ====================================================================
         * CONFIGURATION & CONSTANTES
         * ====================================================================
         */

        const STORAGE_KEY = 'myCollection_v1';
        const SETTINGS_KEY = 'myCollection_settings_v1';

        const INITIAL_STORE = {
            version: "1",
            created_at: new Date().toISOString(),
            categories: {
                films: [],
                livres: [],
                musiques: []
            }
        };

        const INITIAL_SETTINGS = {
            omdbApiKey: "" // Cl√© pour l'API Films
        };

        // Configuration UI des cat√©gories
        const CATEGORY_CONFIG = {
            films: {
                id: 'films',
                label: "Films",
                singular: "Film",
                iconClass: "ph-film-strip",
                color: "bg-blue-100 text-blue-700",
                btnColor: "bg-blue-600 hover:bg-blue-700",
                allowScan: false, // OMDb ne supporte pas bien l'UPC nativement
                fields: [
                    { key: "directors", label: "R√©alisateurs", type: "array" },
                    { key: "producers", label: "Producteurs", type: "array" },
                    { key: "box_office", label: "Box Office", type: "text" },
                    { key: "synopsis", label: "Synopsis", type: "textarea" }
                ]
            },
            livres: {
                id: 'livres',
                label: "Livres",
                singular: "Livre",
                iconClass: "ph-books",
                color: "bg-emerald-100 text-emerald-700",
                btnColor: "bg-emerald-600 hover:bg-emerald-700",
                allowScan: true,
                fields: [
                    { key: "authors", label: "Auteurs", type: "array" },
                    { key: "publisher", label: "√âditeur", type: "text" },
                    { key: "format", label: "Format", type: "select", options: ["roman", "bd", "manga", "autre"] },
                    { key: "summary", label: "R√©sum√©", type: "textarea" }
                ]
            },
            musiques: {
                id: 'musiques',
                label: "Musiques",
                singular: "Album",
                iconClass: "ph-music-notes",
                color: "bg-rose-100 text-rose-700",
                btnColor: "bg-rose-600 hover:bg-rose-700",
                allowScan: true,
                fields: [
                    { key: "artists", label: "Artistes", type: "array" },
                    { key: "label", label: "Label", type: "text" },
                    { key: "sales_or_streams", label: "Ventes/Streams", type: "text" }
                ]
            }
        };

        // Texte d'aide (Markdown simplifi√©)
        const HELP_CONTENT = `
        <h3 class="font-bold text-lg mb-2">Bienvenue sur MyCollection</h3>
        <p class="mb-4 text-sm text-slate-600">Une application autonome pour g√©rer vos films, livres et musiques.</p>

        <h4 class="font-bold mt-4 mb-1">üì∏ Scan Code-Barres</h4>
        <p class="text-sm text-slate-700">Utilisez le bouton scanner <i class="ph-bold ph-barcode"></i> pour ajouter rapidement des livres ou albums via votre cam√©ra.</p>

        <h4 class="font-bold mt-4 mb-1">üîç Recherche Automatique</h4>
        <ul class="list-disc list-inside text-sm space-y-1 text-slate-700">
            <li><strong>Livres :</strong> Utilise OpenLibrary (Gratuit, automatique).</li>
            <li><strong>Musiques :</strong> Utilise MusicBrainz (Gratuit, automatique).</li>
            <li><strong>Films :</strong> Utilise OMDb API. <span class="text-red-500 font-bold">N√©cessite une cl√© API.</span></li>
        </ul>
        <p class="text-xs mt-2 bg-yellow-50 p-2 rounded text-yellow-800 border border-yellow-200">
            Pour les films, obtenez une cl√© gratuite sur <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" class="underline font-bold">omdbapi.com</a> et entrez-la via le bouton <i class="ph-bold ph-gear"></i> R√©glages.
        </p>

        <h4 class="font-bold mt-4 mb-1">üíæ Sauvegarde</h4>
        <p class="text-sm text-slate-700">Vos donn√©es sont stock√©es dans votre navigateur (LocalStorage). Utilisez le bouton <strong>Exporter</strong> pour faire une sauvegarde de s√©curit√© JSON.</p>
        `;

        /**
         * ====================================================================
         * SERVICES API
         * ====================================================================
         */

        const apiService = {
            // Recherche par texte (existant)
            search: async (category, query, settings) => {
                // 1. LIVRES (OpenLibrary)
                if (category === 'livres') {
                    try {
                        const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=5`);
                        const data = await response.json();
                        return data.docs.map(doc => ({
                            title: doc.title,
                            release_year: doc.first_publish_year || new Date().getFullYear(),
                            authors: doc.author_name || ["Inconnu"],
                            publisher: doc.publisher ? doc.publisher[0] : "Inconnu",
                            cover_url: doc.cover_i ? `https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg` : null,
                            summary: `Premi√®re publication en ${doc.first_publish_year}. Langues: ${(doc.language || []).slice(0,3).join(', ')}`,
                            format: "roman"
                        }));
                    } catch (e) { console.error("Erreur OpenLibrary", e); return []; }
                } 
                
                // 2. MUSIQUES (MusicBrainz)
                if (category === 'musiques') {
                    try {
                        const response = await fetch(`https://musicbrainz.org/ws/2/release-group?query=${encodeURIComponent(query)}&fmt=json`, {
                            headers: { 'User-Agent': 'MyCollectionApp/1.0 ( contact@example.com )' }
                        });
                        const data = await response.json();
                        if(!data['release-groups']) return [];
                        return data['release-groups'].slice(0, 8).map(album => {
                            const mbid = album.id;
                            const coverUrl = `https://coverartarchive.org/release-group/${mbid}/front`;
                            return {
                                title: album.title,
                                release_year: album['first-release-date'] ? album['first-release-date'].split('-')[0] : "Inconnu",
                                artists: album['artist-credit'] ? album['artist-credit'].map(a => a.name) : ["Divers"],
                                label: album['primary-type'] || "Album",
                                sales_or_streams: "Non disponible",
                                cover_url: coverUrl,
                                mbid: mbid
                            };
                        });
                    } catch (e) { console.error("Erreur MusicBrainz", e); return []; }
                }

                // 3. FILMS (OMDb)
                if (category === 'films') {
                    const apiKey = settings.omdbApiKey;
                    if (!apiKey) throw new Error("KEY_MISSING");
                    try {
                        const response = await fetch(`https://www.omdbapi.com/?apikey=${apiKey}&s=${encodeURIComponent(query)}&type=movie`);
                        const data = await response.json();
                        if (data.Response === "False") return [];
                        return data.Search.map(movie => ({
                            title: movie.Title,
                            release_year: movie.Year,
                            directors: ["Chargement..."],
                            producers: [],
                            box_office: "",
                            poster_url: movie.Poster !== "N/A" ? movie.Poster : null,
                            synopsis: "Import√© via OMDb.",
                            imdbID: movie.imdbID
                        }));
                    } catch (e) { console.error("Erreur OMDb", e); return []; }
                }
                return [];
            },

            // NOUVEAU: Recherche par Code Barre
            getByBarcode: async (category, code) => {
                // Livres (ISBN) via OpenLibrary
                if (category === 'livres') {
                    const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${code}&format=json&jscmd=data`);
                    const data = await response.json();
                    const bookKey = `ISBN:${code}`;
                    if (!data[bookKey]) throw new Error("Not Found");
                    
                    const book = data[bookKey];
                    return {
                        title: book.title,
                        release_year: book.publish_date ? book.publish_date.slice(-4) : new Date().getFullYear(),
                        authors: book.authors ? book.authors.map(a => a.name) : ["Inconnu"],
                        publisher: book.publishers ? book.publishers[0].name : "Inconnu",
                        cover_url: book.cover ? book.cover.medium : null,
                        summary: `Import√© via scan (ISBN: ${code}). Pages: ${book.number_of_pages || '?'}.`,
                        format: "roman"
                    };
                }

                // Musique (UPC/EAN) via MusicBrainz
                if (category === 'musiques') {
                    const response = await fetch(`https://musicbrainz.org/ws/2/release/?query=barcode:${code}&fmt=json`, {
                        headers: { 'User-Agent': 'MyCollectionApp/1.0 ( contact@example.com )' }
                    });
                    const data = await response.json();
                    if (!data.releases || data.releases.length === 0) throw new Error("Not Found");
                    
                    const album = data.releases[0]; // Prend le premier r√©sultat
                    // Essayer de r√©cup√©rer le release-group pour l'image
                    let coverUrl = null;
                    if (album['release-group']) {
                         coverUrl = `https://coverartarchive.org/release-group/${album['release-group'].id}/front`;
                    }

                    return {
                        title: album.title,
                        release_year: album.date ? album.date.split('-')[0] : "Inconnu",
                        artists: album['artist-credit'] ? album['artist-credit'].map(a => a.name) : ["Divers"],
                        label: album['label-info'] ? album['label-info'][0]?.label?.name : "Inconnu",
                        sales_or_streams: "Non disponible",
                        cover_url: coverUrl
                    };
                }
                
                throw new Error("Scan non support√© pour cette cat√©gorie");
            }
        };

        const generateId = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;

        /**
         * ====================================================================
         * COMPOSANTS UI
         * ====================================================================
         */

        const Icon = ({ name, size = 20, className = "" }) => (
            <i className={`ph ${name} ${className}`} style={{ fontSize: size + 'px' }}></i>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed select-none";
            const variants = {
                primary: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg shadow-slate-900/10",
                secondary: "bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                ghost: "text-slate-600 hover:bg-slate-100"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="flex flex-col gap-1 mb-3">
                {label && <label className="text-xs font-bold uppercase tracking-wider text-slate-500">{label}</label>}
                <input className="w-full px-3 py-2 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all" {...props} />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto flex flex-col slide-up">
                        <div className="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-slate-100 rounded-full text-slate-500 transition">
                                <Icon name="ph-x" size={20} />
                            </button>
                        </div>
                        <div className="p-4 flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const CardItem = ({ item, config, onEdit, onDelete, onView }) => {
            const fallbackImage = `https://placehold.co/400x600/e2e8f0/64748b?text=${encodeURIComponent(item.data.title.substring(0,20))}`;
            return (
                <div className="group bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-lg transition-all overflow-hidden flex flex-col h-full fade-in">
                    <div className="relative aspect-[2/3] overflow-hidden bg-slate-100 cursor-pointer" onClick={() => onView(item)}>
                        <img 
                            src={item.data.cover_url || item.data.poster_url || fallbackImage} 
                            alt={item.data.title}
                            className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                            onError={(e) => { e.target.onerror = null; e.target.src = fallbackImage; }}
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-4">
                        <span className="text-white text-sm font-medium flex items-center gap-1"><Icon name="ph-eye" /> D√©tails</span>
                        </div>
                    </div>
                    <div className="p-3 flex-1 flex flex-col">
                        <h4 className="font-bold text-slate-900 line-clamp-1" title={item.data.title}>{item.data.title}</h4>
                        <div className="text-xs text-slate-500 mb-2 flex justify-between items-center">
                            <span className="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">{item.data.release_year}</span>
                            <span className="truncate max-w-[50%] opacity-80">
                                {item.type === 'films' && (item.data.directors?.[0] || '')}
                                {item.type === 'livres' && (item.data.authors?.[0] || '')}
                                {item.type === 'musiques' && (item.data.artists?.[0] || '')}
                            </span>
                        </div>
                        <div className="mt-auto pt-2 flex gap-2 border-t border-slate-50 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onClick={() => onEdit(item)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded" title="Modifier"><Icon name="ph-pencil-simple" /></button>
                            <button onClick={() => onDelete(item)} className="p-1.5 text-red-600 hover:bg-red-50 rounded ml-auto" title="Supprimer"><Icon name="ph-trash" /></button>
                        </div>
                    </div>
                </div>
            );
        };

        // Composant Scanner
        const BarcodeScanner = ({ onScanSuccess, onError }) => {
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 };
                
                scanner.start(
                    { facingMode: "environment" }, 
                    config, 
                    (decodedText) => {
                        scanner.stop().then(() => {
                            onScanSuccess(decodedText);
                        }).catch(err => console.error("Stop failed", err));
                    },
                    (errorMessage) => {
                        // Scan error, ignore usually
                    }
                ).catch(err => {
                    onError("Erreur cam√©ra: " + err);
                });

                return () => {
                    if(scanner.isScanning) {
                        scanner.stop().catch(err => console.error("Cleanup failed", err));
                    }
                };
            }, []);

            return (
                <div className="w-full flex flex-col items-center">
                    <div id="reader" className="w-full h-64 bg-black rounded-lg overflow-hidden relative"></div>
                    <p className="text-sm text-slate-500 mt-2 text-center">Placez le code-barres dans le cadre.</p>
                </div>
            );
        };

        /**
         * ====================================================================
         * APPLICATION PRINCIPALE
         * ====================================================================
         */

        function App() {
            // -- STATES --
            const [store, setStore] = useState(INITIAL_STORE);
            const [settings, setSettings] = useState(INITIAL_SETTINGS);
            const [currentView, setCurrentView] = useState('home');
            const [notification, setNotification] = useState(null);
            
            // Search & Filters
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [localFilter, setLocalFilter] = useState("");

            // Modals
            const [modalMode, setModalMode] = useState(null); // 'search_select', 'edit', 'view', 'help', 'settings', 'scan'
            const [selectedItem, setSelectedItem] = useState(null);
            const [formData, setFormData] = useState({});

            // -- EFFECTS --
            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) setStore(JSON.parse(savedData));
                
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) setSettings(JSON.parse(savedSettings));
            }, []);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
            }, [store]);

            useEffect(() => {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }, [settings]);

            // -- HELPERS --
            const showToast = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const goToHome = () => {
                setCurrentView('home');
                setSearchQuery("");
                setSearchResults([]);
                setLocalFilter("");
            };

            // -- CRUD ACTIONS --
            const handleSaveItem = (itemData, type) => {
                const isEdit = !!formData.id;
                const timestamp = new Date().toISOString();
                
                let newItem = isEdit ? 
                    { ...formData, updated_at: timestamp, data: itemData } : 
                    { id: generateId(type), type: type, created_at: timestamp, updated_at: timestamp, data: itemData };

                setStore(prev => {
                    const list = prev.categories[type];
                    if (!isEdit) {
                        const exists = list.find(i => i.data.title.toLowerCase() === newItem.data.title.toLowerCase() && i.data.release_year == newItem.data.release_year);
                        if (exists) {
                            showToast("Cet √©l√©ment semble d√©j√† exister !", "error");
                            return prev;
                        }
                    }
                    const newList = isEdit ? list.map(i => i.id === newItem.id ? newItem : i) : [newItem, ...list];
                    return { ...prev, categories: { ...prev.categories, [type]: newList } };
                });

                showToast(isEdit ? "Modifi√© avec succ√®s" : "Ajout√© avec succ√®s");
                setModalMode(null);
                setSearchQuery("");
                setSearchResults([]);
            };

            const handleDeleteItem = (item) => {
                if (!confirm("Supprimer cet √©l√©ment d√©finitivement ?")) return;
                setStore(prev => ({
                    ...prev,
                    categories: { ...prev.categories, [currentView]: prev.categories[currentView].filter(i => i.id !== item.id) }
                }));
                showToast("√âl√©ment supprim√©");
                if (modalMode === 'view') setModalMode(null);
            };

            const handleClearCategory = () => {
                if (!confirm(`Voulez-vous vraiment vider TOUTE la cat√©gorie ${currentView} ?`)) return;
                setStore(prev => ({ ...prev, categories: { ...prev.categories, [currentView]: [] } }));
                showToast("Cat√©gorie vid√©e");
            };

            // -- SEARCH --
            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                setIsSearching(true);
                setSearchResults([]);
                
                try {
                    const results = await apiService.search(currentView, searchQuery, settings);
                    if (results.length > 0) {
                        setSearchResults(results);
                        setModalMode('search_select');
                    } else {
                        showToast("Aucun r√©sultat trouv√©", "info");
                        setFormData({ data: { title: searchQuery } }); // Pr√©pare manuel
                        setModalMode('edit');
                    }
                } catch (err) {
                    if (err.message === "KEY_MISSING") {
                        showToast("Cl√© API OMDb manquante (voir R√©glages)", "error");
                        setModalMode('settings');
                    } else {
                        showToast("Erreur lors de la recherche", "error");
                    }
                } finally {
                    setIsSearching(false);
                }
            };

            // -- SCANNER LOGIC --
            const handleScanSuccess = async (code) => {
                setModalMode(null); // Close scan modal
                showToast("Code d√©tect√©, recherche...", "info");
                try {
                    const data = await apiService.getByBarcode(currentView, code);
                    setFormData({ data: data });
                    setModalMode('edit');
                } catch (e) {
                    showToast("Code non trouv√© ou erreur API", "error");
                    console.error(e);
                }
            };

            // -- IMPORT / EXPORT --
            const handleExport = () => {
                const dataStr = JSON.stringify(store, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `my_collection_${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const imported = JSON.parse(evt.target.result);
                        if (!imported.categories) throw new Error("Invalid");
                        if (confirm("Remplacer (OK) ou Fusionner (Annuler) ?")) {
                            setStore(imported);
                            showToast("Collection restaur√©e");
                        } else {
                            setStore(prev => ({
                                ...prev,
                                categories: {
                                    films: [...prev.categories.films, ...imported.categories.films],
                                    livres: [...prev.categories.livres, ...imported.categories.livres],
                                    musiques: [...prev.categories.musiques, ...imported.categories.musiques],
                                }
                            }));
                            showToast("Donn√©es fusionn√©es");
                        }
                    } catch (err) { showToast("Fichier invalide", "error"); }
                };
                reader.readAsText(file);
            };

            // -- RENDER HELPERS --
            const currentConfig = CATEGORY_CONFIG[currentView];
            const currentList = store.categories[currentView] || [];
            
            // --- LOGIQUE DE FILTRE AMELIOREE ---
            const filteredList = currentList.filter(item => {
                if (!localFilter) return true;
                const query = localFilter.toLowerCase();
                const d = item.data;
                
                // Recherche g√©n√©rique (Titre, Ann√©e)
                let match = (d.title && d.title.toLowerCase().includes(query)) || 
                            (d.release_year && d.release_year.toString().includes(query));

                // Recherche sp√©cifique : Livres (Auteurs)
                if (currentView === 'livres' && d.authors && Array.isArray(d.authors)) {
                    match = match || d.authors.some(a => a.toLowerCase().includes(query));
                }

                // Recherche sp√©cifique : Musiques (Artistes)
                if (currentView === 'musiques' && d.artists && Array.isArray(d.artists)) {
                    match = match || d.artists.some(a => a.toLowerCase().includes(query));
                }

                return match;
            }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const totalItems = Object.values(store.categories).reduce((acc, cat) => acc + cat.length, 0);

            // -- TOAST COMPONENT (Rendered inline) --
            const Toast = () => {
                if (!notification) return null;
                const bg = notification.type === 'error' ? 'bg-red-500' : (notification.type === 'info' ? 'bg-blue-500' : 'bg-slate-800');
                return (
                    <div className={`fixed bottom-4 right-4 ${bg} text-white px-4 py-2 rounded-lg shadow-xl z-50 fade-in flex items-center gap-2`}>
                         <Icon name={notification.type === 'error' ? "ph-warning" : "ph-check-circle"} />
                         {notification.msg}
                    </div>
                );
            };

            /**
             * VIEW: HOME
             */
            if (currentView === 'home') {
                return (
                    <div className="min-h-screen pb-10">
                        <Toast />
                        <header className="bg-white border-b px-6 py-6 mb-8">
                            <div className="max-w-4xl mx-auto flex justify-between items-center">
                                <h1 className="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent flex items-center gap-2">
                                    <Icon name="ph-stack" className="text-indigo-600" /> MyCollection
                                </h1>
                                <div className="flex gap-2">
                                    <Button variant="ghost" onClick={() => setModalMode('help')} title="Aide">
                                        <Icon name="ph-question" size={24} />
                                    </Button>
                                    <Button variant="ghost" onClick={() => setModalMode('settings')} title="R√©glages">
                                        <Icon name="ph-gear" size={24} />
                                    </Button>
                                </div>
                            </div>
                        </header>

                        <main className="max-w-4xl mx-auto px-4 fade-in">
                            <div className="text-center mb-10 py-8">
                                <p className="text-5xl font-black text-slate-800 mb-2">{totalItems}</p>
                                <p className="text-slate-500 uppercase tracking-widest text-xs font-bold">Objets dans la collection</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                                {Object.values(CATEGORY_CONFIG).map(conf => {
                                    const count = store.categories[conf.id].length;
                                    return (
                                        <button key={conf.id} onClick={() => setCurrentView(conf.id)}
                                            className="group relative overflow-hidden bg-white rounded-2xl p-6 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 text-left border border-slate-100">
                                            <div className={`absolute top-0 right-0 p-16 opacity-10 rounded-bl-full transition-transform group-hover:scale-110 ${conf.color.replace('bg-', 'bg-current text-')}`}></div>
                                            <div className={`inline-flex p-3 rounded-xl mb-4 ${conf.color}`}>
                                                <Icon name={conf.iconClass} size={32} />
                                            </div>
                                            <h2 className="text-xl font-bold mb-1">{conf.label}</h2>
                                            <p className="text-slate-500 text-sm">{count} √©l√©ments</p>
                                        </button>
                                    )
                                })}
                            </div>

                            <div className="flex justify-center gap-4">
                                <Button variant="secondary" onClick={handleExport}><Icon name="ph-download-simple" /> Exporter JSON</Button>
                                <label className="cursor-pointer bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg font-medium text-sm flex items-center gap-2 shadow-sm transition">
                                    <Icon name="ph-upload-simple" /> Importer JSON
                                    <input type="file" className="hidden" accept=".json" onChange={handleImport} />
                                </label>
                            </div>
                        </main>

                        {/* MODALE REGLAGES */}
                        <Modal isOpen={modalMode === 'settings'} onClose={() => setModalMode(null)} title="R√©glages">
                            <div className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded-lg text-blue-800 text-sm flex gap-3">
                                    <Icon name="ph-info" size={24} className="shrink-0" />
                                    <p>Les cl√©s API sont stock√©es uniquement dans votre navigateur (LocalStorage).</p>
                                </div>
                                <Input 
                                    label="Cl√© API OMDb (Films)" 
                                    placeholder="Ex: a1b2c3d4" 
                                    value={settings.omdbApiKey} 
                                    onChange={e => setSettings({...settings, omdbApiKey: e.target.value})} 
                                />
                                <div className="text-xs text-slate-500">
                                    Requise pour la recherche automatique de films. Obtenir une cl√© gratuite : <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" className="underline text-indigo-600">omdbapi.com</a>
                                </div>
                                <div className="pt-4">
                                    <Button onClick={() => setModalMode(null)} className="w-full">Enregistrer</Button>
                                </div>
                            </div>
                        </Modal>

                        {/* MODALE AIDE */}
                        <Modal isOpen={modalMode === 'help'} onClose={() => setModalMode(null)} title="Guide d'utilisation">
                            <div className="prose prose-sm text-slate-700" dangerouslySetInnerHTML={{ __html: HELP_CONTENT }}></div>
                        </Modal>
                    </div>
                );
            }

            /**
             * VIEW: CATEGORY
             */
            return (
                <div className="min-h-screen pb-20">
                    <Toast />
                    <header className="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <button onClick={goToHome} className="p-2 hover:bg-slate-100 rounded-full transition"><Icon name="ph-arrow-left" size={20} /></button>
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    {currentConfig.label} <span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full">{currentList.length}</span>
                                </h1>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="ghost" onClick={handleClearCategory} className="text-red-500 hover:bg-red-50 hidden sm:flex"><Icon name="ph-trash" /></Button>
                                
                                {/* BOUTON SCANNER (Conditionnel) */}
                                {currentConfig.allowScan && (
                                    <Button variant="secondary" onClick={() => setModalMode('scan')} title="Scanner Code-Barre">
                                        <Icon name="ph-barcode" size={22} /> <span className="hidden sm:inline">Scanner</span>
                                    </Button>
                                )}

                                <Button variant="primary" className={currentConfig.btnColor} onClick={() => { setFormData({}); setModalMode('edit'); }}>
                                    <Icon name="ph-plus" /> <span className="hidden sm:inline">Ajout manuel</span>
                                </Button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
                        {/* Recherche API */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex gap-2 flex-col sm:flex-row">
                            <div className="relative flex-1">
                                <Icon name="ph-magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                <input 
                                    type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                                    placeholder={`Recherche web (Ajout auto) pour ${currentConfig.singular}...`}
                                    className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none"
                                />
                            </div>
                            <Button onClick={handleSearch} disabled={isSearching || !searchQuery}>
                                {isSearching ? <Icon name="ph-spinner" className="animate-spin" /> : "Rechercher"}
                            </Button>
                        </div>

                        {/* Filtre local & Liste */}
                        <div>
                            <div className="flex justify-between items-center mb-4 gap-4">
                                <h3 className="text-sm font-bold uppercase tracking-wider text-slate-500 whitespace-nowrap">Ma Liste</h3>
                                {/* Champ de recherche locale am√©lior√© */}
                                <div className="relative w-full max-w-xs">
                                    <Icon name="ph-funnel" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                    <input 
                                        type="text" 
                                        placeholder={
                                            currentView === 'films' ? "Filtrer par titre..." :
                                            currentView === 'livres' ? "Filtrer titre ou auteur..." : 
                                            "Filtrer titre ou artiste..."
                                        } 
                                        value={localFilter} onChange={(e) => setLocalFilter(e.target.value)}
                                        className="w-full pl-9 pr-3 py-1.5 text-sm rounded-lg border border-slate-200 bg-transparent focus:bg-white transition-colors outline-none focus:border-indigo-500"
                                    />
                                </div>
                            </div>

                            {filteredList.length === 0 ? (
                                <div className="text-center py-20 bg-slate-100/50 rounded-2xl border-2 border-dashed border-slate-200">
                                    <div className={`inline-flex p-4 rounded-full bg-white mb-4 shadow-sm text-slate-400`}>
                                        <Icon name={currentConfig.iconClass} size={32} />
                                    </div>
                                    <p className="text-slate-500">
                                        {localFilter ? "Aucun r√©sultat pour ce filtre." : "Collection vide."}
                                    </p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 fade-in">
                                    {filteredList.map(item => (
                                        <CardItem key={item.id} item={item} config={currentConfig}
                                            onView={(itm) => { setSelectedItem(itm); setModalMode('view'); }}
                                            onEdit={(itm) => { setFormData(itm); setModalMode('edit'); }}
                                            onDelete={handleDeleteItem}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>

                    {/* --- MODALES --- */}

                    {/* SELECTEUR RECHERCHE */}
                    <Modal isOpen={modalMode === 'search_select'} onClose={() => setModalMode(null)} title="R√©sultats Web">
                        <div className="space-y-2">
                            {searchResults.map((res, idx) => (
                                <div key={idx} onClick={() => { setFormData({data: res}); setModalMode('edit'); }} 
                                    className="flex gap-4 p-2 rounded-lg hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition items-center">
                                    <img src={res.cover_url || res.poster_url || "https://placehold.co/100x150?text=?"} className="w-12 h-16 object-cover rounded bg-slate-200" />
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-bold text-slate-800 truncate">{res.title}</h4>
                                        <p className="text-sm text-slate-500">{res.release_year} ‚Ä¢ {res.artists?.join(', ') || res.authors?.join(', ') || res.directors?.join(', ')}</p>
                                    </div>
                                    <Icon name="ph-plus-circle" className="text-indigo-600" size={24} />
                                </div>
                            ))}
                            <div className="pt-4 border-t mt-2">
                                <Button variant="ghost" onClick={() => {setFormData({}); setModalMode('edit'); }} className="w-full text-sm">Rien ne correspond ? Ajout manuel</Button>
                            </div>
                        </div>
                    </Modal>

                    {/* SCANNER MODAL */}
                    <Modal isOpen={modalMode === 'scan'} onClose={() => setModalMode(null)} title="Scanner un code-barres">
                         <BarcodeScanner 
                            onScanSuccess={handleScanSuccess} 
                            onError={(err) => console.log(err)} 
                         />
                         <div className="mt-4 text-xs text-center text-slate-500 bg-slate-50 p-2 rounded">
                            Supporte les livres (ISBN) et Albums (EAN/UPC).<br/>Assurez-vous d'avoir une bonne luminosit√©.
                         </div>
                    </Modal>

                    {/* EDITION / AJOUT */}
                    <Modal isOpen={modalMode === 'edit'} onClose={() => setModalMode(null)} title={formData.id ? "Modifier" : "Ajouter / V√©rifier"}>
                        <form onSubmit={(e) => { e.preventDefault(); handleSaveItem(formData.data, currentView); }} className="space-y-4">
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <Input label="Titre" required value={formData.data?.title || ''} onChange={e => setFormData({...formData, data: {...formData.data, title: e.target.value}})} />
                                </div>
                                <div className="w-24">
                                    <Input label="Ann√©e" type="number" value={formData.data?.release_year || ''} onChange={e => setFormData({...formData, data: {...formData.data, release_year: e.target.value}})} />
                                </div>
                            </div>
                            
                            <Input label="URL Image" value={formData.data?.poster_url || formData.data?.cover_url || ''} 
                                onChange={e => setFormData({...formData, data: {...formData.data, [currentView === 'films' ? 'poster_url' : 'cover_url']: e.target.value}})} placeholder="https://..." />

                            {currentConfig.fields.map(field => {
                                const val = formData.data?.[field.key];
                                const strVal = Array.isArray(val) ? val.join(', ') : (val || '');
                                
                                if (field.type === 'textarea') return (
                                    <div key={field.key}>
                                        <label className="text-xs font-bold uppercase text-slate-500">{field.label}</label>
                                        <textarea className="w-full px-3 py-2 rounded-lg border border-slate-300 h-24 text-sm mt-1"
                                            value={strVal} onChange={e => setFormData({...formData, data: {...formData.data, [field.key]: e.target.value}})} />
                                    </div>
                                );
                                if (field.type === 'select') return (
                                    <div key={field.key}>
                                        <label className="text-xs font-bold uppercase text-slate-500">{field.label}</label>
                                        <select className="w-full px-3 py-2 rounded-lg border border-slate-300 mt-1 bg-white" value={strVal} onChange={e => setFormData({...formData, data: {...formData.data, [field.key]: e.target.value}})}>
                                            {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                );
                                return (
                                    <Input key={field.key} label={field.label} value={strVal} placeholder={field.type === 'array' ? "S√©parer par virgules" : ""}
                                        onChange={e => setFormData({...formData, data: {...formData.data, [field.key]: field.type === 'array' ? e.target.value.split(',') : e.target.value}})} />
                                );
                            })}
                            <div className="pt-4 flex gap-3">
                                <Button type="button" variant="ghost" onClick={() => setModalMode(null)} className="flex-1">Annuler</Button>
                                <Button type="submit" variant="primary" className={`flex-1 ${currentConfig.btnColor}`}>Enregistrer</Button>
                            </div>
                        </form>
                    </Modal>

                    {/* DETAILS */}
                    <Modal isOpen={modalMode === 'view' && selectedItem} onClose={() => setModalMode(null)} title="D√©tails">
                        {selectedItem && (
                            <div className="text-center sm:text-left">
                                <img src={selectedItem.data.cover_url || selectedItem.data.poster_url || "https://placehold.co/300?text=No+Img"} 
                                    className="w-1/2 mx-auto sm:w-full rounded-lg shadow-lg mb-4 sm:float-left sm:mr-4 sm:w-32" />
                                <h2 className="text-2xl font-bold text-slate-900">{selectedItem.data.title}</h2>
                                <p className="text-lg text-slate-500 font-medium mb-4">{selectedItem.data.release_year}</p>
                                
                                <div className="clear-both grid gap-2 text-sm text-left bg-slate-50 p-4 rounded-lg">
                                    {currentConfig.fields.map(field => {
                                        const val = selectedItem.data[field.key];
                                        if (!val || (Array.isArray(val) && val.length === 0)) return null;
                                        return (
                                            <div key={field.key}>
                                                <span className="font-bold text-slate-700">{field.label}: </span>
                                                <span className="text-slate-600">{Array.isArray(val) ? val.join(', ') : val}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="mt-6 flex gap-2">
                                    <Button onClick={() => { setFormData(selectedItem); setModalMode('edit'); }} className="flex-1" variant="secondary"><Icon name="ph-pencil-simple" /> Modifier</Button>
                                </div>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
